<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial &mdash; filibuster  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tools" href="tools.html" />
    <link rel="prev" title="Overview" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> filibuster
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Using Filibuster</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#creating-your-flask-apps">Creating your Flask Apps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#flask-app-setup">Flask App Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#filibuster-tutorial-networking-json"><code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/networking.json</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#filibuster-tutorial-makefile"><code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/Makefile</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#creating-the-baz-app">Creating the <code class="docutils literal notranslate"><span class="pre">baz</span></code> App</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-the-bar-app">Creating the <code class="docutils literal notranslate"><span class="pre">bar</span></code> App</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-the-foo-app">Creating the <code class="docutils literal notranslate"><span class="pre">foo</span></code> App</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#functional-testing">Functional Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#finding-the-bug">Finding the Bug</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-our-functional-test">Updating our Functional Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="#computing-coverage">Computing Coverage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#targeting-precise-errors">Targeting Precise Errors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Filibuster Corpus</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running</a></li>
<li class="toctree-l1"><a class="reference internal" href="cinema-examples.html">Cinema Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry-examples.html">Industry Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extending Filibuster</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-overview.html">Instrumentation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-flask.html">Instrumentation Example: Flask</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-requests.html">Instrumentation Example: Requests</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Writing Instrumentation: GRPC</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-overview.html">Instrumenting GRPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-client.html">Instrumenting Remote Service Calls</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-server.html">Instrumenting Services To Receive Calls</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-client-fi.html">Enabling Fault-Injection in the Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-client-analysis.html">Static Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Filibuster Server API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-formats.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-server-create.html">HTTP API: Create</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-server-update.html">HTTP API: Update</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-server-new-test-execution.html">HTTP API: New Test Execution</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">filibuster</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline"></a></h1>
<p>This tutorial contains step-by-step instructions for debugging a local application using Filibuster.</p>
<p>In this tutorial, you will:</p>
<ol class="arabic simple">
<li><p>Create three Flask apps that work together to respond “foo bar baz” to a client (one of which contains a bug.)</p></li>
<li><p>Write functional tests for your Flask apps.</p></li>
<li><p>Use Filibuster to find the bug.</p></li>
<li><p>Fix the bug and verify resilience with Filibuster in your local, development environment.</p></li>
</ol>
<section id="creating-your-flask-apps">
<h2>Creating your Flask Apps<a class="headerlink" href="#creating-your-flask-apps" title="Permalink to this headline"></a></h2>
<p>For this tutorial, we will build our example application in the style of an application in our corpus.  Therefore,
you should first clone the Filibuster corpus.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone http://github.com/filibuster-testing/filibuster-corpus.git
<span class="nb">cd</span> filibuster-corpus
</pre></div>
</div>
<section id="flask-app-setup">
<h3>Flask App Setup<a class="headerlink" href="#flask-app-setup" title="Permalink to this headline"></a></h3>
<p>Create the basic structure for your apps:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir filibuster-tutorial                                <span class="c1"># This is where you&#39;ll be putting all files for this tutorial.</span>
mkdir filibuster-tutorial/services                       <span class="c1"># This is where you will write your apps.</span>
mkdir filibuster-tutorial/functional
touch filibuster-tutorial/functional/test_foo_bar_baz.py <span class="c1"># This is where you will write the functional test for your apps.</span>
touch filibuster-tutorial/networking.json                <span class="c1"># This is where you will write networking information for your apps.</span>
touch filibuster-tutorial/Makefile                       <span class="c1"># This is where you will write the Makefile for your apps.</span>
</pre></div>
</div>
<section id="filibuster-tutorial-networking-json">
<h4><code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/networking.json</span></code><a class="headerlink" href="#filibuster-tutorial-networking-json" title="Permalink to this headline"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/networking.json</span></code> specifies networking information including ports, hosts, and timeout
lengths for your apps.  Our corpus has a makefile for starting, waiting for services to come online, and stopping
services that uses this networking information to make requests to each of your services.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/networking.json</span></code>, add networking
information for each of our three services (<code class="docutils literal notranslate"><span class="pre">foo</span></code>, <code class="docutils literal notranslate"><span class="pre">bar</span></code>, and <code class="docutils literal notranslate"><span class="pre">baz</span></code>) and <code class="docutils literal notranslate"><span class="pre">filibuster</span></code>:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;foo&quot;</span> <span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;port&quot;</span><span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>
      <span class="s2">&quot;default-host&quot;</span><span class="o">:</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;timeout-seconds&quot;</span><span class="o">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="s2">&quot;bar&quot;</span> <span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;port&quot;</span><span class="o">:</span> <span class="mi">5001</span><span class="p">,</span>
      <span class="s2">&quot;default-host&quot;</span><span class="o">:</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;timeout-seconds&quot;</span><span class="o">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="s2">&quot;baz&quot;</span> <span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;port&quot;</span><span class="o">:</span> <span class="mi">5002</span><span class="p">,</span>
      <span class="s2">&quot;default-host&quot;</span><span class="o">:</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;timeout-seconds&quot;</span><span class="o">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="s2">&quot;filibuster&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;port&quot;</span><span class="o">:</span> <span class="mi">5005</span><span class="p">,</span>
      <span class="s2">&quot;default-host&quot;</span><span class="o">:</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;timeout-seconds&quot;</span><span class="o">:</span> <span class="mi">10</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="filibuster-tutorial-makefile">
<h4><code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/Makefile</span></code><a class="headerlink" href="#filibuster-tutorial-makefile" title="Permalink to this headline"></a></h4>
<p>In <code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/Makefile</span></code>, add the following to define the services you are implementing, the ports that those
services run on and then include the shared makefile that provides helpers for automatically starting and stopping each
of your services.</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">reqs</span> <span class="n">unit</span> <span class="n">functional</span>

<span class="nv">example</span> <span class="o">=</span> filibuster-tutorial
<span class="nv">services</span> <span class="o">=</span> foo bar baz
<span class="nv">ports</span> <span class="o">=</span> <span class="m">5000</span> <span class="m">5001</span> <span class="m">5002</span>
<span class="nv">filibuster-port</span> <span class="o">=</span> <span class="m">5005</span>

<span class="cp">include ../shared_build_examples.mk</span>
</pre></div>
</div>
<p>Then create the files you will be working with for this tutorial. These files will specify the three different Flask apps needed
to respond “foo bar baz” to a client. These files include <code class="docutils literal notranslate"><span class="pre">python</span></code> files as well as the infrastructure needed to run the apps
using Filibuster. Run the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loop through the three services that we want to create (and their associated ports) and create initial file structure.</span>
<span class="c1"># Note the services and corresponding ports correspond to filibuster-tutorial/networking.json</span>
<span class="k">for</span> i in <span class="s2">&quot;foo 5000&quot;</span> <span class="s2">&quot;bar 5001&quot;</span> <span class="s2">&quot;baz 5002&quot;</span>
<span class="k">do</span>
    <span class="nb">set</span> -- <span class="nv">$i</span>
    <span class="nv">service</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">port</span><span class="o">=</span><span class="nv">$2</span>

    mkdir -p <span class="s2">&quot;filibuster-tutorial/services/</span><span class="nv">$service</span><span class="s2">/</span><span class="nv">$service</span><span class="s2">&quot;</span>
    touch <span class="s2">&quot;filibuster-tutorial/services/</span><span class="nv">$service</span><span class="s2">/</span><span class="nv">$service</span><span class="s2">/__init__.py&quot;</span>

    <span class="c1"># This is where you will will implement your Flask apps.</span>
    touch <span class="s2">&quot;filibuster-tutorial/services/</span><span class="nv">$service</span><span class="s2">/</span><span class="nv">$service</span><span class="s2">/app.py&quot;</span>

    <span class="c1"># Each service must have a Makefile specifying information for Filibuster.</span>
    <span class="nv">makefile</span><span class="o">=</span><span class="s2">&quot;APP=filibuster-tutorial\nSERVICE=</span><span class="nv">$service</span><span class="s2">\nPORT=</span><span class="nv">$port</span><span class="s2">\n\n.PHONY: test reqs\n\ninclude ../../../shared_build_services.mk&quot;</span>

    <span class="c1"># Specify information about the service, used by Filibuster.</span>
    <span class="nb">echo</span> -e <span class="nv">$makefile</span> &gt;&gt; filibuster-tutorial/services/<span class="nv">$service</span>/Makefile
<span class="k">done</span>
</pre></div>
</div>
</section>
</section>
<section id="creating-the-baz-app">
<h3>Creating the <code class="docutils literal notranslate"><span class="pre">baz</span></code> App<a class="headerlink" href="#creating-the-baz-app" title="Permalink to this headline"></a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/service/baz/baz/app.py</span></code>, add the following code to implement the service.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="kn">import</span> <span class="n">ServiceUnavailable</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">examples_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">examples_path</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">helper</span>
<span class="n">helper</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">Helper</span><span class="p">(</span><span class="s2">&quot;filibuster-tutorial&quot;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">## Instrument using filibuster</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">examples_path</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">filibuster.instrumentation.requests</span> <span class="kn">import</span> <span class="n">RequestsInstrumentor</span> <span class="k">as</span> <span class="n">FilibusterRequestsInstrumentor</span>
<span class="n">FilibusterRequestsInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;baz&quot;</span><span class="p">,</span> <span class="n">filibuster_url</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;filibuster&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">filibuster.instrumentation.flask</span> <span class="kn">import</span> <span class="n">FlaskInstrumentor</span> <span class="k">as</span> <span class="n">FilibusterFlaskInstrumentor</span>
<span class="n">FilibusterFlaskInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;baz&quot;</span><span class="p">,</span> <span class="n">filibuster_url</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;filibuster&#39;</span><span class="p">))</span>

<span class="c1"># filibuster requires a health check app to ensure service is running</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/health-check&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">baz_health_check</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span> <span class="p">})</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/baz&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">baz</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;baz&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_port</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">),</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_debug</span><span class="p">())</span>
</pre></div>
</div>
<p>Note the instrumentation code under <code class="docutils literal notranslate"><span class="pre">##</span> <span class="pre">Instrument</span> <span class="pre">using</span> <span class="pre">filibuster</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">filibuster.instrumentation.requests</span> <span class="kn">import</span> <span class="n">RequestsInstrumentor</span> <span class="k">as</span> <span class="n">FilibusterRequestsInstrumentor</span>
<span class="n">FilibusterRequestsInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;baz&quot;</span><span class="p">,</span> <span class="n">filibuster_url</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;filibuster&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">filibuster.instrumentation.flask</span> <span class="kn">import</span> <span class="n">FlaskInstrumentor</span> <span class="k">as</span> <span class="n">FilibusterFlaskInstrumentor</span>
<span class="n">FilibusterFlaskInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;baz&quot;</span><span class="p">,</span> <span class="n">filibuster_url</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;filibuster&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Each service you create will need to include this code, with <code class="docutils literal notranslate"><span class="pre">service_name</span></code> updated accordingly. This instrumentation
code allows Filibuster to instrument both <code class="docutils literal notranslate"><span class="pre">flask</span></code> and <code class="docutils literal notranslate"><span class="pre">requests</span></code>, which in turn allows Filibuster to test
different fault combinations.</p>
</section>
<section id="creating-the-bar-app">
<h3>Creating the <code class="docutils literal notranslate"><span class="pre">bar</span></code> App<a class="headerlink" href="#creating-the-bar-app" title="Permalink to this headline"></a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/service/bar/bar/app.py</span></code>, add the following code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="kn">import</span> <span class="n">ServiceUnavailable</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">examples_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">examples_path</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">helper</span>
<span class="n">helper</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">Helper</span><span class="p">(</span><span class="s2">&quot;filibuster-tutorial&quot;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">## Instrument using filibuster</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">examples_path</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">filibuster.instrumentation.requests</span> <span class="kn">import</span> <span class="n">RequestsInstrumentor</span> <span class="k">as</span> <span class="n">FilibusterRequestsInstrumentor</span>
<span class="n">FilibusterRequestsInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">filibuster_url</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;filibuster&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">filibuster.instrumentation.flask</span> <span class="kn">import</span> <span class="n">FlaskInstrumentor</span> <span class="k">as</span> <span class="n">FilibusterFlaskInstrumentor</span>
<span class="n">FilibusterFlaskInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">filibuster_url</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;filibuster&#39;</span><span class="p">))</span>

<span class="c1"># filibuster requires a health check app to ensure service is running</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/health-check&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">bar_health_check</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span> <span class="p">})</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/bar/baz&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;{}/baz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">)),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_timeout</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ServiceUnavailable</span><span class="p">(</span><span class="s2">&quot;The baz service is unavailable.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ServiceUnavailable</span><span class="p">(</span><span class="s2">&quot;The baz service timed out.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ServiceUnavailable</span><span class="p">(</span><span class="s2">&quot;The baz service is malfunctioning.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;bar &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_port</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_debug</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="creating-the-foo-app">
<h3>Creating the <code class="docutils literal notranslate"><span class="pre">foo</span></code> App<a class="headerlink" href="#creating-the-foo-app" title="Permalink to this headline"></a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/service/foo/foo/app.py</span></code>, add the following code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="kn">import</span> <span class="n">ServiceUnavailable</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">examples_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">examples_path</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">helper</span>
<span class="n">helper</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">Helper</span><span class="p">(</span><span class="s2">&quot;filibuster-tutorial&quot;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">## Instrument using filibuster</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">examples_path</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">filibuster.instrumentation.requests</span> <span class="kn">import</span> <span class="n">RequestsInstrumentor</span> <span class="k">as</span> <span class="n">FilibusterRequestsInstrumentor</span>
<span class="n">FilibusterRequestsInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">filibuster_url</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;filibuster&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">filibuster.instrumentation.flask</span> <span class="kn">import</span> <span class="n">FlaskInstrumentor</span> <span class="k">as</span> <span class="n">FilibusterFlaskInstrumentor</span>
<span class="n">FilibusterFlaskInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">filibuster_url</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;filibuster&#39;</span><span class="p">))</span>

<span class="c1"># filibuster requires a health check app to ensure service is running</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/health-check&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">foo_health_check</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span> <span class="p">})</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/foo/bar/baz&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;{}/bar/baz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_timeout</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ServiceUnavailable</span><span class="p">(</span><span class="s2">&quot;The bar service timed out.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ServiceUnavailable</span><span class="p">(</span><span class="s2">&quot;The bar service is malfunctioning.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;foo &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_port</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">),</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_debug</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>
<section id="functional-testing">
<h2>Functional Testing<a class="headerlink" href="#functional-testing" title="Permalink to this headline"></a></h2>
<p>Now that your Flask apps are created, write a functional test. This test will ensure that our three apps work
together to return “foo bar baz” to a client. In <code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/functional/test_foo_bar_baz.py</span></code>, add
the following code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">examples_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">examples_path</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">helper</span>
<span class="n">helper</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">Helper</span><span class="p">(</span><span class="s2">&quot;filibuster-tutorial&quot;</span><span class="p">)</span>

<span class="c1"># Note that tests should be prefixed with test_functional for filibuster compatibility</span>
<span class="k">def</span> <span class="nf">test_functional_foo_bar_baz</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;{}/foo/bar/baz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_timeout</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;foo bar baz&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_functional_foo_bar_baz</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, let’s verify that the functional test passes.  First, let’s start the required services.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> filibuster-tutorial
make local-start
</pre></div>
</div>
<p>Now, run the functional test.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>chmod <span class="m">755</span> functionaal/test_foo_bar_baz.py
./functional/test_foo_bar_baz.py
</pre></div>
</div>
<p>At this point, your test should pass.  If it doesn’t, please make sure your services were implemented correctly as
described above, and that you have started the services using the <code class="docutils literal notranslate"><span class="pre">local-start</span></code> make target.</p>
<section id="finding-the-bug">
<h3>Finding the Bug<a class="headerlink" href="#finding-the-bug" title="Permalink to this headline"></a></h3>
<p>Let’s use Filibuster to identify bugs using fault injection.  First, we can use Filibuster to identify bugs using a
default set of faults for the application.  We can do that using the Filibuster CLI tool.</p>
<p>First, install Filibuster.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install filibuster
</pre></div>
</div>
<p>Next, provide the Filibuster CLI tool with the path to the functional test.  If we don’t specify what faults to inject,
Filibuster will use test default set of common faults.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>filibuster --functional-test ./functional/test_foo_bar_baz.py
</pre></div>
</div>
<p>We should see output like the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span> * Serving Flask app <span class="s2">&quot;filibuster.server&quot;</span> <span class="o">(</span>lazy loading<span class="o">)</span>
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on all addresses.
   WARNING: This is a development server. Do not use it in a production deployment.
 * Running on http://100.68.79.169:5005/ <span class="o">(</span>Press CTRL+C to quit<span class="o">)</span>
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;GET /health-check HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>NOTICE<span class="o">]</span>: Running <span class="nb">test</span> ./functional/test_foo_bar_baz.py
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Running initial non-failing execution <span class="o">(</span><span class="nb">test</span> <span class="m">1</span><span class="o">)</span> ./functional/test_foo_bar_baz.py
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;GET /filibuster/new-test-execution/foo HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;PUT /filibuster/create HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;POST /filibuster/update HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;GET /filibuster/new-test-execution/bar HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;PUT /filibuster/create HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;POST /filibuster/update HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;POST /filibuster/update HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;POST /filibuster/update HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: <span class="o">[</span>DONE<span class="o">]</span> Running initial non-failing execution <span class="o">(</span><span class="nb">test</span> <span class="m">1</span><span class="o">)</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Running <span class="nb">test</span> <span class="m">2</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Total tests pruned so far: <span class="m">0</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Total tests remaining: <span class="m">9</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: <span class="o">=====================================================================================</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Test number: <span class="m">2</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: gen_id: <span class="m">0</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   module: requests
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   method: get
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   args: <span class="o">[</span><span class="s1">&#39;5001/bar/baz&#39;</span><span class="o">]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   kwargs: <span class="o">{}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   vclock: <span class="o">{</span><span class="s1">&#39;foo&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   origin_vclock: <span class="o">{}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   execution_index: <span class="o">[[</span><span class="s2">&quot;b13f73ac8ced79cb093a638972923de1&quot;</span>, <span class="m">1</span><span class="o">]]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: gen_id: <span class="m">1</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   module: requests
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   method: get
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   args: <span class="o">[</span><span class="s1">&#39;5002/baz&#39;</span><span class="o">]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   kwargs: <span class="o">{}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   vclock: <span class="o">{</span><span class="s1">&#39;foo&#39;</span>: <span class="m">1</span>, <span class="s1">&#39;bar&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   origin_vclock: <span class="o">{</span><span class="s1">&#39;foo&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   execution_index: <span class="o">[[</span><span class="s2">&quot;b13f73ac8ced79cb093a638972923de1&quot;</span>, <span class="m">1</span><span class="o">]</span>, <span class="o">[</span><span class="s2">&quot;e654c4b77587b601e5a5767a82a27f45&quot;</span>, <span class="m">1</span><span class="o">]]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * Failed with metadata: <span class="o">[(</span><span class="s1">&#39;return_value&#39;</span>, <span class="o">{</span><span class="s1">&#39;status_code&#39;</span>: <span class="s1">&#39;503&#39;</span><span class="o">})]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Failures <span class="k">for</span> this execution:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: <span class="o">[[</span><span class="s2">&quot;b13f73ac8ced79cb093a638972923de1&quot;</span>, <span class="m">1</span><span class="o">]</span>, <span class="o">[</span><span class="s2">&quot;e654c4b77587b601e5a5767a82a27f45&quot;</span>, <span class="m">1</span><span class="o">]]</span>: <span class="o">[(</span><span class="s1">&#39;return_value&#39;</span>, <span class="o">{</span><span class="s1">&#39;status_code&#39;</span>: <span class="s1">&#39;503&#39;</span><span class="o">})]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: <span class="o">=====================================================================================</span>
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;GET /filibuster/new-test-execution/foo HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;PUT /filibuster/create HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;POST /filibuster/update HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;GET /filibuster/new-test-execution/bar HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;PUT /filibuster/create HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;POST /filibuster/update HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:35:05<span class="o">]</span> <span class="s2">&quot;POST /filibuster/update HTTP/1.1&quot;</span> <span class="m">200</span> -
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/private/tmp/filibuster-corpus/filibuster-tutorial/./functional/test_foo_bar_baz.py&quot;</span>, line <span class="m">19</span>, in &lt;module&gt;
    test_functional_foo_bar_baz<span class="o">()</span>
  File <span class="s2">&quot;/private/tmp/filibuster-corpus/filibuster-tutorial/./functional/test_foo_bar_baz.py&quot;</span>, line <span class="m">16</span>, in test_functional_foo_bar_baz
    assert response.status_code <span class="o">==</span> <span class="m">200</span> and response.text <span class="o">==</span> <span class="s2">&quot;foo bar baz&quot;</span>
AssertionError
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>FAIL<span class="o">]</span>: Test failed<span class="p">;</span> counterexample file written: counterexample.json
</pre></div>
</div>
<p>What we see here is an assertion failure: the status code and text do not match when a fault was injected.  We can see
from further back in the output the precise fault that was injected.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: gen_id: <span class="m">1</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   module: requests
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   method: get
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   args: <span class="o">[</span><span class="s1">&#39;5002/baz&#39;</span><span class="o">]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   kwargs: <span class="o">{}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   vclock: <span class="o">{</span><span class="s1">&#39;foo&#39;</span>: <span class="m">1</span>, <span class="s1">&#39;bar&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   origin_vclock: <span class="o">{</span><span class="s1">&#39;foo&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   execution_index: <span class="o">[[</span><span class="s2">&quot;b13f73ac8ced79cb093a638972923de1&quot;</span>, <span class="m">1</span><span class="o">]</span>, <span class="o">[</span><span class="s2">&quot;e654c4b77587b601e5a5767a82a27f45&quot;</span>, <span class="m">1</span><span class="o">]]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * Failed with metadata: <span class="o">[(</span><span class="s1">&#39;return_value&#39;</span>, <span class="o">{</span><span class="s1">&#39;status_code&#39;</span>: <span class="s1">&#39;503&#39;</span><span class="o">})]</span>
</pre></div>
</div>
<p>Here, we see that the request from <code class="docutils literal notranslate"><span class="pre">bar</span></code> to <code class="docutils literal notranslate"><span class="pre">baz</span></code> was failed with a 503 Service Unavailable response.  This response caused the entire request to no longer return a 200 OK containing “foo bar baz”.</p>
<p>If we want to re-run that precise test, we can using the counterexample that Filibuster provided.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>filibuster --functional-test ./functional/test_foo_bar_baz.py --counterexample-file counterexample.json
</pre></div>
</div>
</section>
<section id="updating-our-functional-test">
<h3>Updating our Functional Test<a class="headerlink" href="#updating-our-functional-test" title="Permalink to this headline"></a></h3>
<p>In order to keep testing, we need to update our assertions in our test to reflect the behavior we expect under failure.</p>
<p>Instead of only ensuring that our three apps successfully return “foo bar baz” to a client, we also want to allow the
request to <code class="docutils literal notranslate"><span class="pre">foo</span></code> to fail gracefully.  To ensure the request fails only when it should, we should use the
<code class="docutils literal notranslate"><span class="pre">filibuster.assertions</span></code> module. <code class="docutils literal notranslate"><span class="pre">filibuster.assertions</span></code>’s <code class="docutils literal notranslate"><span class="pre">was_fault_injected()</span></code> tells us whether:</p>
<ul class="simple">
<li><p>a fault has been injected, meaning <code class="docutils literal notranslate"><span class="pre">response.status_code</span></code> should be a failure status code</p></li>
<li><p>or not, meaning <code class="docutils literal notranslate"><span class="pre">response.status_code</span></code> should be <code class="docutils literal notranslate"><span class="pre">200</span></code> and “foo bar baz” should be returned</p></li>
</ul>
<p>Adjust <code class="docutils literal notranslate"><span class="pre">filibuster-tutorial/functional/test_foo_bar_baz.py</span></code> to incorporate <code class="docutils literal notranslate"><span class="pre">filibuster.assertions</span></code>’s <code class="docutils literal notranslate"><span class="pre">was_fault_injected()</span></code> so that it matches the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">filibuster.assertions</span> <span class="kn">import</span> <span class="n">was_fault_injected</span>

<span class="n">examples_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">examples_path</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">helper</span>
<span class="n">helper</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">Helper</span><span class="p">(</span><span class="s2">&quot;filibuster-tutorial&quot;</span><span class="p">)</span>

<span class="c1"># Note that tests should be prefixed with test_functional for filibuster compatibility</span>
<span class="k">def</span> <span class="nf">test_functional_foo_bar_baz</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;{}/foo/bar/baz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">helper</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">helper</span><span class="o">.</span><span class="n">get_timeout</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="n">was_fault_injected</span><span class="p">())</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;foo bar baz&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">was_fault_injected</span><span class="p">()</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">503</span><span class="p">,</span> <span class="mi">404</span><span class="p">]</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_functional_foo_bar_baz</span><span class="p">()</span>
</pre></div>
</div>
<p>Filibuster’s assertions module also provides a more granular assertion: <code class="docutils literal notranslate"><span class="pre">was_fault_injected_on(service_name)</span></code> that can
be used to write more precise assertions.</p>
<p>Let’s re-run the counterexample; with our updated assertion, the test should now pass!</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>filibuster --functional-test ./functional/test_foo_bar_baz.py --counterexample-file counterexample.json
</pre></div>
</div>
<p>Now, we can run Filibuster again and test for the whole default set of failures as well.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>filibuster --functional-test ./functional/test_foo_bar_baz.py
</pre></div>
</div>
<p>After 10 tests, we run into another failure.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Running <span class="nb">test</span> <span class="m">11</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Total tests pruned so far: <span class="m">1</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Total tests remaining: <span class="m">0</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: <span class="o">=====================================================================================</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Test number: <span class="m">11</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: gen_id: <span class="m">0</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   module: requests
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   method: get
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   args: <span class="o">[</span><span class="s1">&#39;5001/bar/baz&#39;</span><span class="o">]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   kwargs: <span class="o">{}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   vclock: <span class="o">{</span><span class="s1">&#39;foo&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   origin_vclock: <span class="o">{}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:   execution_index: <span class="o">[[</span><span class="s2">&quot;b13f73ac8ced79cb093a638972923de1&quot;</span>, <span class="m">1</span><span class="o">]]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * Failed with exception: <span class="o">{</span><span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;requests.exceptions.ConnectionError&#39;</span>, <span class="s1">&#39;metadata&#39;</span>: <span class="o">{}}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Failures <span class="k">for</span> this execution:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: <span class="o">[[</span><span class="s2">&quot;b13f73ac8ced79cb093a638972923de1&quot;</span>, <span class="m">1</span><span class="o">]]</span>: <span class="o">{</span><span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;requests.exceptions.ConnectionError&#39;</span>, <span class="s1">&#39;metadata&#39;</span>: <span class="o">{}}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: <span class="o">=====================================================================================</span>
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:55:54<span class="o">]</span> <span class="s2">&quot;GET /filibuster/new-test-execution/foo HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:55:54<span class="o">]</span> <span class="s2">&quot;PUT /filibuster/create HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:55:54<span class="o">]</span> <span class="s2">&quot;POST /filibuster/update HTTP/1.1&quot;</span> <span class="m">200</span> -
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2021 <span class="m">10</span>:55:54<span class="o">]</span> <span class="s2">&quot;GET /fault-injected HTTP/1.1&quot;</span> <span class="m">200</span> -
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/private/tmp/filibuster-corpus/filibuster-tutorial/./functional/test_foo_bar_baz.py&quot;</span>, line <span class="m">24</span>, in &lt;module&gt;
    test_functional_foo_bar_baz<span class="o">()</span>
  File <span class="s2">&quot;/private/tmp/filibuster-corpus/filibuster-tutorial/./functional/test_foo_bar_baz.py&quot;</span>, line <span class="m">21</span>, in test_functional_foo_bar_baz
    assert was_fault_injected<span class="o">()</span> and response.status_code in <span class="o">[</span><span class="m">503</span>, <span class="m">404</span><span class="o">]</span>
AssertionError
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>FAIL<span class="o">]</span>: Test failed<span class="p">;</span> counterexample file written: counterexample.json
</pre></div>
</div>
<p>Again, we have another counterexample file.  If we look at the precise fault that was injected, we can see that the
request between <code class="docutils literal notranslate"><span class="pre">foo</span></code> and <code class="docutils literal notranslate"><span class="pre">bar</span></code> was failed with a ConnectionError exception.  Since the <code class="docutils literal notranslate"><span class="pre">foo</span></code> service does not
have an exception handler for this fault, the service returns a 500 Internal Server Error: we do not expect this response
in our functional test.</p>
<p>Instead of altering our functional test to allow for a 500 Internal Server Error, we want the service to return a 503
Service Unavailable if one of the dependencies is down.  Therefore, we will modify the implementation of the <code class="docutils literal notranslate"><span class="pre">foo</span></code>
service to handle this failure.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">ServiceUnavailable</span><span class="p">(</span><span class="s2">&quot;The bar service is unavailable.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can verify our fix using counterexample replay.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>filibuster --functional-test ./functional/test_foo_bar_baz.py --counterexample-file counterexample.json
</pre></div>
</div>
<p>Finally, we can run Filibuster again and test for the whole default set of failures as well.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>filibuster --functional-test ./functional/test_foo_bar_baz.py
</pre></div>
</div>
<p>At this point, everything passes!</p>
</section>
<section id="computing-coverage">
<h3>Computing Coverage<a class="headerlink" href="#computing-coverage" title="Permalink to this headline"></a></h3>
<p>From here, you can use Filibuster to compute coverage.  Coverage files are not available until the services are shutdown,
so we must shut the services down.  Then, we can use the Filibuster tool to generate coverage, which will be rendered as
html in the <code class="docutils literal notranslate"><span class="pre">htmlcov</span></code> directory.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>make local-stop
filibuster-coverage
</pre></div>
</div>
<p>You can see that, even though we only wrote a test that exercised the failure-free path of the <code class="docutils literal notranslate"><span class="pre">foo</span></code> service,
Filibuster automatically generated the necessary tests to cover the failure scenarios.  This coverage is aggregated
across all generated Filibuster tests and for all services.</p>
<img alt="_images/tutorial-coverage.png" src="_images/tutorial-coverage.png" />
</section>
</section>
<section id="targeting-precise-errors">
<h2>Targeting Precise Errors<a class="headerlink" href="#targeting-precise-errors" title="Permalink to this headline"></a></h2>
<p>Up to now, we have been using Filibuster with a default set of faults.  However, what if your application generates
a failure that is not included in the default set?  To do that, we can use the Filibuster analysis tool to generate
a custom list of faults and failures to inject.</p>
<p>To do this, we run the following command.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>filibuster-analysis --services-directory services --output-file analysis.json
</pre></div>
</div>
<p>This command will invoke the Filibuster static analysis tool.  The analysis tool will look in the directory <code class="docutils literal notranslate"><span class="pre">services</span></code>
for the implementation of each service and output an <code class="docutils literal notranslate"><span class="pre">analysis.json</span></code> file that can be provided to Filibuster for
more targeted fault injection.</p>
<p>You should see output like the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: About to analyze directory: services
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * found service implementation: services/foo
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * found service implementation: services/baz
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * found service implementation: services/bar
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Found services: <span class="o">[</span><span class="s1">&#39;foo&#39;</span>, <span class="s1">&#39;baz&#39;</span>, <span class="s1">&#39;bar&#39;</span><span class="o">]</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Analyzing service foo at directory services/foo
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * starting analysis of Python file: services/foo/foo/__init__.py
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * identified HTTP error: <span class="o">{</span><span class="s1">&#39;return_value&#39;</span>: <span class="o">{</span><span class="s1">&#39;status_code&#39;</span>: <span class="s1">&#39;500&#39;</span><span class="o">}}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * starting analysis of Python file: services/foo/foo/app.py
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * identified HTTP error: <span class="o">{</span><span class="s1">&#39;return_value&#39;</span>: <span class="o">{</span><span class="s1">&#39;status_code&#39;</span>: <span class="s1">&#39;503&#39;</span><span class="o">}}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Analyzing service baz at directory services/baz
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * starting analysis of Python file: services/baz/baz/__init__.py
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * identified HTTP error: <span class="o">{</span><span class="s1">&#39;return_value&#39;</span>: <span class="o">{</span><span class="s1">&#39;status_code&#39;</span>: <span class="s1">&#39;500&#39;</span><span class="o">}}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * starting analysis of Python file: services/baz/baz/app.py
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Analyzing service bar at directory services/bar
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * starting analysis of Python file: services/bar/bar/__init__.py
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * identified HTTP error: <span class="o">{</span><span class="s1">&#39;return_value&#39;</span>: <span class="o">{</span><span class="s1">&#39;status_code&#39;</span>: <span class="s1">&#39;500&#39;</span><span class="o">}}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * starting analysis of Python file: services/bar/bar/app.py
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: * identified HTTP error: <span class="o">{</span><span class="s1">&#39;return_value&#39;</span>: <span class="o">{</span><span class="s1">&#39;status_code&#39;</span>: <span class="s1">&#39;503&#39;</span><span class="o">}}</span>
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>:
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Writing output file: analysis.json
<span class="o">[</span>FILIBUSTER<span class="o">]</span> <span class="o">[</span>INFO<span class="o">]</span>: Done.
</pre></div>
</div>
<p>From here, you can provide the analysis file directly to the Filibuster tool.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>filibuster --functional-test ./functional/test_foo_bar_baz.py --analysis-file analysis.json
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tools.html" class="btn btn-neutral float-right" title="Tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Christopher S. Meiklejohn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>