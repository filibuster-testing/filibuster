<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Instrumenting Remote Service Calls &mdash; filibuster  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Instrumenting Services To Receive Calls" href="instrumentation-grpc-server.html" />
    <link rel="prev" title="Instrumenting GRPC" href="instrumentation-grpc-overview.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> filibuster
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Using Filibuster</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Filibuster Corpus</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running</a></li>
<li class="toctree-l1"><a class="reference internal" href="cinema-examples.html">Cinema Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry-examples.html">Industry Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extending Filibuster</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-overview.html">Instrumentation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-flask.html">Instrumentation Example: Flask</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-requests.html">Instrumentation Example: Requests</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Writing Instrumentation: GRPC</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-overview.html">Instrumenting GRPC</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Instrumenting Remote Service Calls</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#identifying-the-call-site">Identifying the Call Site</a></li>
<li class="toctree-l2"><a class="reference internal" href="#potentially-reset-state">Potentially Reset State</a></li>
<li class="toctree-l2"><a class="reference internal" href="#update-the-vector-clock">Update the Vector Clock</a></li>
<li class="toctree-l2"><a class="reference internal" href="#update-the-execution-index">Update the Execution Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="#keep-track-of-the-origin-vclock">Keep Track of the Origin VClock</a></li>
<li class="toctree-l2"><a class="reference internal" href="#record-the-invocation">Record the Invocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-metadata-to-request">Add Metadata to Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="#invocation-completed-success">Invocation Completed: Success</a></li>
<li class="toctree-l2"><a class="reference internal" href="#invocation-completed-exception">Invocation Completed: Exception</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-server.html">Instrumenting Services To Receive Calls</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-client-fi.html">Enabling Fault-Injection in the Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-client-analysis.html">Static Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Filibuster Server API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-formats.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-server-create.html">HTTP API: Create</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-server-update.html">HTTP API: Update</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-server-new-test-execution.html">HTTP API: New Test Execution</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">filibuster</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Instrumenting Remote Service Calls</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/instrumentation-grpc-client.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="instrumenting-remote-service-calls">
<h1>Instrumenting Remote Service Calls<a class="headerlink" href="#instrumenting-remote-service-calls" title="Permalink to this headline"></a></h1>
<p>To start, we need to keep track of the remote calls issued by each service and their responses.  To enable dynamic reduction, we need to also associate vector clocks and execution indexes with each request that’s issued.</p>
<p>To achieve this, we extend the <cite>opentelemetry</cite> instrumentation for <cite>grpc</cite> with the modifications listed below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These modifications currently only cover the unary invoker on the insecure channel (without the use of futures.)  Those modifications are straightforward, but are omitted here for this prototype implementation.</p>
</div>
<section id="identifying-the-call-site">
<h2>Identifying the Call Site<a class="headerlink" href="#identifying-the-call-site" title="Permalink to this headline"></a></h2>
<p>First, we need to identify the call site uniquely.  We do this by including any lines of code in our instrumentation and
compute a hash based on this traceback.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## *******************************************************************************************</span>
<span class="c1">## START CALLSITE INFORMATION</span>
<span class="c1">## *******************************************************************************************</span>

<span class="n">raw_callsite</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">service_name</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">TEST_PREFIX</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">INSTRUMENTATION_PREFIX</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">raw_callsite</span> <span class="o">=</span> <span class="n">line</span>
        <span class="k">break</span>

<span class="n">cs_search</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;File </span><span class="se">\&quot;</span><span class="s2">(.*)</span><span class="se">\&quot;</span><span class="s2">, line (.*), in&quot;</span><span class="p">)</span>
<span class="n">callsite</span> <span class="o">=</span> <span class="n">cs_search</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">raw_callsite</span><span class="p">)</span>

<span class="n">callsite_file</span> <span class="o">=</span> <span class="n">callsite</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">callsite_line</span> <span class="o">=</span> <span class="n">callsite</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;=&gt; callsite_file: &quot;</span> <span class="o">+</span> <span class="n">callsite_file</span><span class="p">)</span>
<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;=&gt; callsite_line: &quot;</span> <span class="o">+</span> <span class="n">callsite_line</span><span class="p">)</span>

<span class="n">full_traceback</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">())</span>
<span class="n">full_traceback_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">full_traceback</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;=&gt; full_traceback_hash: &quot;</span> <span class="o">+</span> <span class="n">full_traceback_hash</span><span class="p">)</span>

<span class="c1">## *******************************************************************************************</span>
<span class="c1">## END CALLSITE INFORMATION</span>
<span class="c1">## *******************************************************************************************</span>
</pre></div>
</div>
</section>
<section id="potentially-reset-state">
<h2>Potentially Reset State<a class="headerlink" href="#potentially-reset-state" title="Permalink to this headline"></a></h2>
<p>If this is the first request in a new test execution, we reset the execution index and vector clock state.  Once we have
done that, we initialize a new vector clock and a new execution index and associate it with the request id for this request.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## *******************************************************************************************</span>
<span class="c1">## START CLOCK RESET</span>
<span class="c1">## *******************************************************************************************</span>

<span class="c1"># Get the request id.</span>
<span class="n">request_id_string</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_REQUEST_ID_KEY</span><span class="p">)</span>
<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;request_id_string: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_string</span><span class="p">))</span>

<span class="c1"># Figure out if this is the first request in a new test execution.</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_INSTRUMENTATION_KEY</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DISABLE_SERVER_COMMUNICATION&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filibuster_new_test_execution_url</span><span class="p">(</span><span class="n">filibuster_url</span><span class="p">,</span> <span class="n">service_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">notice</span><span class="p">(</span><span class="s2">&quot;clock reset response: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
<span class="n">context</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="c1"># Reset EI and vclock if this is a new test execution.</span>
<span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;new-test-execution&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;new-test-execution&#39;</span><span class="p">]):</span>
    <span class="n">vclocks_by_request</span> <span class="o">=</span> <span class="p">{</span><span class="n">request_id_string</span><span class="p">:</span> <span class="n">vclock_new</span><span class="p">()}</span>
    <span class="n">_filibuster_global_context_set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_VCLOCK_BY_REQUEST_KEY</span><span class="p">,</span> <span class="n">vclocks_by_request</span><span class="p">)</span>

    <span class="n">execution_indices_by_request</span> <span class="o">=</span> <span class="p">{</span><span class="n">request_id_string</span><span class="p">:</span> <span class="n">execution_index_new</span><span class="p">()}</span>
    <span class="n">_filibuster_global_context_set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EI_BY_REQUEST_KEY</span><span class="p">,</span> <span class="n">execution_indices_by_request</span><span class="p">)</span>

<span class="c1">## *******************************************************************************************</span>
<span class="c1">## END CLOCK RESET</span>
<span class="c1">## *******************************************************************************************</span>
</pre></div>
</div>
</section>
<section id="update-the-vector-clock">
<h2>Update the Vector Clock<a class="headerlink" href="#update-the-vector-clock" title="Permalink to this headline"></a></h2>
<p>We take the incoming vector clock from the thread context and merge it with the current vector clock associated with this
request id.  Then, we advance the clock to account for the current request being issued by the node.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## *******************************************************************************************</span>
<span class="c1">## START INCOMING AND LOCAL CLOCK WORK</span>
<span class="c1">## *******************************************************************************************</span>

<span class="c1"># Incoming clock from the request that triggered this service to be reached.</span>
<span class="n">incoming_vclock_string</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_VCLOCK_KEY</span><span class="p">)</span>

<span class="c1"># If it&#39;s not none, we probably need to merge with our clock, first, since our clock is keeping</span>
<span class="c1"># track of *our* requests from this node.</span>
<span class="k">if</span> <span class="n">incoming_vclock_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">incoming_vclock</span> <span class="o">=</span> <span class="n">vclock_fromstring</span><span class="p">(</span><span class="n">incoming_vclock_string</span><span class="p">)</span>
    <span class="n">vclocks_by_request</span> <span class="o">=</span> <span class="n">_filibuster_global_context_get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_VCLOCK_BY_REQUEST_KEY</span><span class="p">)</span>
    <span class="n">local_vclock</span> <span class="o">=</span> <span class="n">vclocks_by_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id_string</span><span class="p">,</span> <span class="n">vclock_new</span><span class="p">())</span>
    <span class="n">new_local_vclock</span> <span class="o">=</span> <span class="n">vclock_merge</span><span class="p">(</span><span class="n">incoming_vclock</span><span class="p">,</span> <span class="n">local_vclock</span><span class="p">)</span>
    <span class="n">vclocks_by_request</span><span class="p">[</span><span class="n">request_id_string</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_local_vclock</span>
    <span class="n">_filibuster_global_context_set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_VCLOCK_BY_REQUEST_KEY</span><span class="p">,</span> <span class="n">vclocks_by_request</span><span class="p">)</span>

<span class="c1"># Finally, advance the clock to account for this request.</span>
<span class="n">vclocks_by_request</span> <span class="o">=</span> <span class="n">_filibuster_global_context_get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_VCLOCK_BY_REQUEST_KEY</span><span class="p">)</span>
<span class="n">local_vclock</span> <span class="o">=</span> <span class="n">vclocks_by_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id_string</span><span class="p">,</span> <span class="n">vclock_new</span><span class="p">())</span>
<span class="n">new_local_vclock</span> <span class="o">=</span> <span class="n">vclock_increment</span><span class="p">(</span><span class="n">local_vclock</span><span class="p">,</span> <span class="n">service_name</span><span class="p">)</span>
<span class="n">vclocks_by_request</span><span class="p">[</span><span class="n">request_id_string</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_local_vclock</span>
<span class="n">_filibuster_global_context_set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_VCLOCK_BY_REQUEST_KEY</span><span class="p">,</span> <span class="n">vclocks_by_request</span><span class="p">)</span>
<span class="n">vclock</span> <span class="o">=</span> <span class="n">vclocks_by_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id_string</span><span class="p">,</span> <span class="n">vclock_new</span><span class="p">())</span>

<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;clock now: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vclocks_by_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id_string</span><span class="p">,</span> <span class="n">vclock_new</span><span class="p">())))</span>

<span class="c1">## *******************************************************************************************</span>
<span class="c1">## END INCOMING AND LOCAL CLOCK WORK</span>
<span class="c1">## *******************************************************************************************</span>
</pre></div>
</div>
</section>
<section id="update-the-execution-index">
<h2>Update the Execution Index<a class="headerlink" href="#update-the-execution-index" title="Permalink to this headline"></a></h2>
<p>Next, we update the execution index associated with the request by pushing on the unique hash of the callsite.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## *******************************************************************************************</span>
<span class="c1">## START EXECUTION INDEX WORK</span>
<span class="c1">## *******************************************************************************************</span>

<span class="c1"># Get incoming execution index.</span>
<span class="n">incoming_execution_index_string</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EXECUTION_INDEX_KEY</span><span class="p">)</span>

<span class="k">if</span> <span class="n">incoming_execution_index_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">incoming_execution_index</span> <span class="o">=</span> <span class="n">execution_index_fromstring</span><span class="p">(</span><span class="n">incoming_execution_index_string</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">execution_indices_by_request</span> <span class="o">=</span> <span class="n">_filibuster_global_context_get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EI_BY_REQUEST_KEY</span><span class="p">)</span>
    <span class="n">incoming_execution_index</span> <span class="o">=</span> <span class="n">execution_indices_by_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id_string</span><span class="p">,</span> <span class="n">execution_index_new</span><span class="p">())</span>

<span class="c1"># TODO: need to have add additional fields: module, method, args.</span>
<span class="n">execution_index_hash</span> <span class="o">=</span> <span class="n">unique_request_hash</span><span class="p">([</span><span class="n">full_traceback_hash</span><span class="p">])</span>

<span class="c1"># Advance execution index.</span>
<span class="n">execution_indices_by_request</span> <span class="o">=</span> <span class="n">_filibuster_global_context_get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EI_BY_REQUEST_KEY</span><span class="p">)</span>
<span class="n">execution_indices_by_request</span><span class="p">[</span><span class="n">request_id_string</span><span class="p">]</span> <span class="o">=</span> <span class="n">execution_index_push</span><span class="p">(</span><span class="n">execution_index_hash</span><span class="p">,</span> <span class="n">incoming_execution_index</span><span class="p">)</span>
<span class="n">_filibuster_global_context_set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EI_BY_REQUEST_KEY</span><span class="p">,</span> <span class="n">execution_indices_by_request</span><span class="p">)</span>
<span class="n">execution_index</span> <span class="o">=</span> <span class="n">execution_index_tostring</span><span class="p">(</span><span class="n">execution_indices_by_request</span><span class="p">[</span><span class="n">request_id_string</span><span class="p">])</span>

<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;execution index now: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">execution_index_tostring</span><span class="p">(</span><span class="n">execution_indices_by_request</span><span class="p">[</span><span class="n">request_id_string</span><span class="p">])))</span>

<span class="c1">## *******************************************************************************************</span>
<span class="c1">## END EXECUTION INDEX WORK</span>
<span class="c1">## *******************************************************************************************</span>
</pre></div>
</div>
</section>
<section id="keep-track-of-the-origin-vclock">
<h2>Keep Track of the Origin VClock<a class="headerlink" href="#keep-track-of-the-origin-vclock" title="Permalink to this headline"></a></h2>
<p>Finally, we extract the origin vclock that came in as part of the request from the thread context.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## *******************************************************************************************</span>
<span class="c1">## START ORIGIN CLOCK WORK</span>
<span class="c1">## *******************************************************************************************</span>

<span class="c1"># Get the incoming origin vclock from the context.</span>
<span class="n">incoming_origin_vclock_string</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_ORIGIN_VCLOCK_KEY</span><span class="p">)</span>

<span class="c1"># Either use the incoming clock as origin or set to an empty clock.</span>
<span class="k">if</span> <span class="n">incoming_origin_vclock_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">origin_vclock</span> <span class="o">=</span> <span class="n">vclock_fromstring</span><span class="p">(</span><span class="n">incoming_origin_vclock_string</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">origin_vclock</span> <span class="o">=</span> <span class="n">vclock_new</span><span class="p">()</span>

<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;origin_clock: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">origin_vclock</span><span class="p">))</span>

<span class="c1">## *******************************************************************************************</span>
<span class="c1">## END ORIGIN CLOCK WORK</span>
<span class="c1">## *******************************************************************************************</span>
</pre></div>
</div>
</section>
<section id="record-the-invocation">
<h2>Record the Invocation<a class="headerlink" href="#record-the-invocation" title="Permalink to this headline"></a></h2>
<p>Before we issue the request, we make a request to the Filibuster test server registering the invocation.  We include
the module, method, arguments, callsite information along with the execution index, vector clock, and origin vector
clock.  We parse the response and extract out the generated id from the Filibuster server; this allows us to
update the information about this request when the call completes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## *******************************************************************************************</span>
<span class="c1">## START RECORD CALL WORK</span>
<span class="c1">## *******************************************************************************************</span>

<span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">parsed_content</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">generated_id</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">token</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_INSTRUMENTATION_KEY</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DISABLE_SERVER_COMMUNICATION&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># TODO: fix insecure channel hardcode for method</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;instrumentation_type&#39;</span><span class="p">:</span> <span class="s1">&#39;invocation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;source_service_name&#39;</span><span class="p">:</span> <span class="n">service_name</span><span class="p">,</span>
            <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="s1">&#39;grpc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;insecure_channel&#39;</span><span class="p">,</span>
            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">client_info</span><span class="o">.</span><span class="n">full_method</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">)],</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;callsite_file&#39;</span><span class="p">:</span> <span class="n">callsite_file</span><span class="p">,</span>
            <span class="s1">&#39;callsite_line&#39;</span><span class="p">:</span> <span class="n">callsite_line</span><span class="p">,</span>
            <span class="s1">&#39;full_traceback&#39;</span><span class="p">:</span> <span class="n">full_traceback_hash</span><span class="p">,</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;vclock&#39;</span><span class="p">:</span> <span class="n">vclock</span><span class="p">,</span>
            <span class="s1">&#39;origin_vclock&#39;</span><span class="p">:</span> <span class="n">origin_vclock</span><span class="p">,</span>
            <span class="s1">&#39;execution_index&#39;</span><span class="p">:</span> <span class="n">execution_index</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">client_info</span><span class="o">.</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_info</span><span class="o">.</span><span class="n">timeout</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">filibuster_create_url</span><span class="p">(</span><span class="n">filibuster_url</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Exception raised (invocation)!&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">notice</span><span class="p">(</span><span class="s2">&quot;Removing instrumentation key for Filibuster.&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;generated_id&#39;</span> <span class="ow">in</span> <span class="n">parsed_content</span><span class="p">:</span>
            <span class="n">generated_id</span> <span class="o">=</span> <span class="n">parsed_content</span><span class="p">[</span><span class="s1">&#39;generated_id&#39;</span><span class="p">]</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Exception raised (invocation get_json)!&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;parsed_content: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">parsed_content</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;generated_id: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">generated_id</span><span class="p">))</span>

<span class="c1">## *******************************************************************************************</span>
<span class="c1">## END RECORD CALL WORK</span>
<span class="c1">## *******************************************************************************************</span>
</pre></div>
</div>
</section>
<section id="add-metadata-to-request">
<h2>Add Metadata to Request<a class="headerlink" href="#add-metadata-to-request" title="Permalink to this headline"></a></h2>
<p>Before we issue the request, we need to tag it with metadata that will be forwarded to the service that receives the request.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## *******************************************************************************************</span>
<span class="c1">## START METADATA WORK</span>
<span class="c1">## *******************************************************************************************</span>

<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;metadata before: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;x-filibuster-generated-id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">generated_id</span><span class="p">)))</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;x-filibuster-vclock&#39;</span><span class="p">,</span> <span class="n">vclock_tostring</span><span class="p">(</span><span class="n">vclock</span><span class="p">)))</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;x-filibuster-origin-vclock&#39;</span><span class="p">,</span> <span class="n">vclock_tostring</span><span class="p">(</span><span class="n">origin_vclock</span><span class="p">)))</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;x-filibuster-execution-index&#39;</span><span class="p">,</span> <span class="n">execution_index</span><span class="p">))</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;x-filibuster-request-id&#39;</span><span class="p">,</span> <span class="n">request_id_string</span><span class="p">))</span>

<span class="n">notice</span><span class="p">(</span><span class="s2">&quot;metadata after: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>

<span class="c1">## *******************************************************************************************</span>
<span class="c1">## END METADATA WORK</span>
<span class="c1">## *******************************************************************************************</span>
</pre></div>
</div>
</section>
<section id="invocation-completed-success">
<h2>Invocation Completed: Success<a class="headerlink" href="#invocation-completed-success" title="Permalink to this headline"></a></h2>
<p>If the request completes successfully – and we didn’t inject a fault, which we will discuss in the following section –
then, we need to notify the Filibuster server so.  Here, we don’t include the body of the response when the call is
successfully made, as Filibuster does not require that information for fault injection.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## *******************************************************************************************</span>
<span class="c1">## START RECORD SUCCESSFUL RESPONSE</span>
<span class="c1">## *******************************************************************************************</span>

<span class="c1"># Remove request from the execution index.</span>
<span class="n">execution_indices_by_request</span> <span class="o">=</span> <span class="n">_filibuster_global_context_get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EI_BY_REQUEST_KEY</span><span class="p">)</span>
<span class="n">request_id_string</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_REQUEST_ID_KEY</span><span class="p">)</span>
<span class="n">execution_indices_by_request</span><span class="p">[</span><span class="n">request_id_string</span><span class="p">]</span> <span class="o">=</span> <span class="n">execution_index_pop</span><span class="p">(</span><span class="n">execution_indices_by_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id_string</span><span class="p">,</span> <span class="n">execution_index_new</span><span class="p">()))</span>
<span class="n">_filibuster_global_context_set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EI_BY_REQUEST_KEY</span><span class="p">,</span> <span class="n">execution_indices_by_request</span><span class="p">)</span>

<span class="c1"># Notify the Filibuster server that the call succeeded.</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_INSTRUMENTATION_KEY</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DISABLE_SERVER_COMMUNICATION&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;__class__&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;instrumentation_type&#39;</span><span class="p">:</span> <span class="s1">&#39;invocation_complete&#39;</span><span class="p">,</span>
            <span class="s1">&#39;generated_id&#39;</span><span class="p">:</span> <span class="n">generated_id</span><span class="p">,</span>
            <span class="s1">&#39;execution_index&#39;</span><span class="p">:</span> <span class="n">execution_index</span><span class="p">,</span>
            <span class="s1">&#39;vclock&#39;</span><span class="p">:</span> <span class="n">vclock</span><span class="p">,</span>
            <span class="s1">&#39;return_value&#39;</span><span class="p">:</span> <span class="n">return_value</span>
        <span class="p">}</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">filibuster_update_url</span><span class="p">(</span><span class="n">filibuster_url</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Exception raised recording successful response!&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">notice</span><span class="p">(</span><span class="s2">&quot;Removing instrumentation key for Filibuster.&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="c1">## *******************************************************************************************</span>
<span class="c1">## END RECORD SUCCESSFUL RESPONSE</span>
<span class="c1">## *******************************************************************************************</span>
</pre></div>
</div>
</section>
<section id="invocation-completed-exception">
<h2>Invocation Completed: Exception<a class="headerlink" href="#invocation-completed-exception" title="Permalink to this headline"></a></h2>
<p>If the request completes with an exception, we notify the Filibuster server of the exceptional response and include the GRPC status code as metadata to the exception.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## *******************************************************************************************</span>
<span class="c1">## START RECORD EXCEPTIONAL RESPONSE</span>
<span class="c1">## *******************************************************************************************</span>

<span class="c1"># Remove request from the execution index.</span>
<span class="n">execution_indices_by_request</span> <span class="o">=</span> <span class="n">_filibuster_global_context_get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EI_BY_REQUEST_KEY</span><span class="p">)</span>
<span class="n">request_id_string</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">_FILIBUSTER_REQUEST_ID_KEY</span><span class="p">)</span>
<span class="n">execution_indices_by_request</span><span class="p">[</span><span class="n">request_id_string</span><span class="p">]</span> <span class="o">=</span> <span class="n">execution_index_pop</span><span class="p">(</span><span class="n">execution_indices_by_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id_string</span><span class="p">,</span> <span class="n">execution_index_new</span><span class="p">()))</span>
<span class="n">_filibuster_global_context_set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EI_BY_REQUEST_KEY</span><span class="p">,</span> <span class="n">execution_indices_by_request</span><span class="p">)</span>

<span class="c1"># Notify the Filibuster server that the call succeeded.</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_INSTRUMENTATION_KEY</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DISABLE_SERVER_COMMUNICATION&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;instrumentation_type&#39;</span><span class="p">:</span> <span class="s1">&#39;invocation_complete&#39;</span><span class="p">,</span>
            <span class="s1">&#39;generated_id&#39;</span><span class="p">:</span> <span class="n">generated_id</span><span class="p">,</span>
            <span class="s1">&#39;execution_index&#39;</span><span class="p">:</span> <span class="n">execution_index</span><span class="p">,</span>
            <span class="s1">&#39;vclock&#39;</span><span class="p">:</span> <span class="n">vclock</span><span class="p">,</span>
            <span class="s1">&#39;exception&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
                <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">code</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;StatusCode.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">filibuster_update_url</span><span class="p">(</span><span class="n">filibuster_url</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Exception raised recording exceptional response!&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">notice</span><span class="p">(</span><span class="s2">&quot;Removing instrumentation key for Filibuster.&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="c1">## *******************************************************************************************</span>
<span class="c1">## END RECORD EXCEPTIONAL RESPONSE</span>
<span class="c1">## *******************************************************************************************</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="instrumentation-grpc-overview.html" class="btn btn-neutral float-left" title="Instrumenting GRPC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="instrumentation-grpc-server.html" class="btn btn-neutral float-right" title="Instrumenting Services To Receive Calls" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Christopher S. Meiklejohn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>