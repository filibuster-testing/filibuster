<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Instrumentation Example: Flask &mdash; filibuster  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Instrumentation Example: Requests" href="instrumentation-requests.html" />
    <link rel="prev" title="Instrumentation Overview" href="instrumentation-overview.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> filibuster
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Using Filibuster</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Filibuster Corpus</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running</a></li>
<li class="toctree-l1"><a class="reference internal" href="cinema-examples.html">Cinema Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry-examples.html">Industry Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extending Filibuster</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="instrumentation-overview.html">Instrumentation Overview</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Instrumentation Example: Flask</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-requests.html">Instrumentation Example: Requests</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Writing Instrumentation: GRPC</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-overview.html">Instrumenting GRPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-client.html">Instrumenting Remote Service Calls</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-server.html">Instrumenting Services To Receive Calls</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-client-fi.html">Enabling Fault-Injection in the Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-grpc-client-analysis.html">Static Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Filibuster Server API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-formats.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-server-create.html">HTTP API: Create</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-server-update.html">HTTP API: Update</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation-server-new-test-execution.html">HTTP API: New Test Execution</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">filibuster</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Instrumentation Example: Flask</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/instrumentation-flask.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="instrumentation-example-flask">
<h1>Instrumentation Example: Flask<a class="headerlink" href="#instrumentation-example-flask" title="Permalink to this headline"></a></h1>
<p>We start with looking at our Flask instrumentation.</p>
<p>For our Flask instrumentation, we build on the popular <code class="docutils literal notranslate"><span class="pre">opentelemetry</span></code> library.  To do this, we modified a copy of the <code class="docutils literal notranslate"><span class="pre">opentelemetry-instrumentation-flask</span></code> library and made the following modifications.</p>
<p>We start by modifying the <code class="docutils literal notranslate"><span class="pre">before_request</span></code> callback that is executed when an incoming HTTP request is received, but before the application code associated with that route is executed.  We only execute the additional code we are adding if the headers of this request contain a Filibuster generated id header; this allows us to distinguish calls coming from a Filibuster instrumented service.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;X-Filibuster-Generated-Id&#39;</span> <span class="ow">in</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span> <span class="ow">and</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Filibuster-Generated-Id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</pre></div>
</div>
<p>We next setup the instrumentation calls payload.  In this call, we are going to notify the Filibuster server of the service that the request was terminated at.  In the case of <code class="docutils literal notranslate"><span class="pre">cinema-1</span></code>’s first request, it is a call from the users service to the bookings service; therefore, we set the <code class="docutils literal notranslate"><span class="pre">target_service_name</span></code> field to bookings and the other fields accordingly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;instrumentation_type&#39;</span><span class="p">:</span> <span class="s1">&#39;request_received&#39;</span><span class="p">,</span>
    <span class="s1">&#39;generated_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Filibuster-Generated-Id&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;execution_index&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Filibuster-Execution-Index&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;target_service_name&#39;</span><span class="p">:</span> <span class="n">service_name</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using a thread context object provided by the opentelemetry library we extend, we now set the values that we need to propagate to future calls.  This includes the origin vclock, the vclock, and the execution index.  In this example, the constants used here are just strings that represent the name of a key to use in this thread context dictionary.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_VCLOCK_KEY</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Filibuster-VClock&#39;</span><span class="p">]))</span>
<span class="n">context</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_ORIGIN_VCLOCK_KEY</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Filibuster-Origin-VClock&#39;</span><span class="p">]))</span>
<span class="n">context</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_EXECUTION_INDEX_KEY</span><span class="p">,</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Filibuster-Execution-Index&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p>Finally, we set a value on the thread context object to indicate that the next request we are going to issue is an instrumentation call – therefore, we can avoid performing fault injection on our instrumentation – issue the instrumentation call to the Filibuster server, unset the token, and then proceed on with the rest of the original implementation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">token</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">_FILIBUSTER_INSTRUMENTATION_KEY</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">filibuster_update_url</span><span class="p">(</span><span class="n">filibuster_url</span><span class="p">),</span> <span class="n">json</span> <span class="o">=</span> <span class="n">payload</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Exception raised during instrumentation (_record_successful_response)!&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing instrumentation key for Filibuster.&quot;</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="instrumentation-overview.html" class="btn btn-neutral float-left" title="Instrumentation Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="instrumentation-requests.html" class="btn btn-neutral float-right" title="Instrumentation Example: Requests" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Christopher S. Meiklejohn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>